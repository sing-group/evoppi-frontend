<!--
  ~  EvoPPI Frontend
  ~
  ~  Copyright (C) 2017-2018 - Noé Vázquez González,
  ~  Miguel Reboiro-Jato, Jorge Vieira, Hugo López-Fernández,
  ~  and Cristina Vieira.
  ~
  ~  This program is free software: you can redistribute it and/or modify
  ~  it under the terms of the GNU General Public License as published by
  ~  the Free Software Foundation, either version 3 of the License, or
  ~  (at your option) any later version.
  ~
  ~  This program is distributed in the hope that it will be useful,
  ~  but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  ~  GNU General Public License for more details.
  ~
  ~  You should have received a copy of the GNU General Public License
  ~  along with this program. If not, see <http://www.gnu.org/licenses/>.
  -->
<mat-card *ngIf="!showForm">
  <mat-card-content>
    <button mat-raised-button color="primary" (click)="showForm = true">New query</button>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="showForm">
  <mat-card-content>
    <form [formGroup]="formSameSpecies" (change)="onChangeForm()">
      <span>
        <mat-form-field class="width-100">
          <mat-select placeholder="Species" [value]="formSameSpecies.value.species" (change)="onChangeSpecies($event.value)" formControlName="species">
            <mat-option *ngFor="let specie of species" [value]="specie">
              {{ specie.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="width-50">
          <mat-select placeholder="Interactome A" formControlName="interactomeA" (selectionChange)="onSelectInteractomeA($event.value)"
                      [value]="formSameSpecies.value.interactomeA" >
            <mat-option *ngFor="let interactome of interactomesA" [value]="interactome">
              {{ interactome.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="width-50 right">
          <mat-select placeholder="Interactome B" formControlName="interactomeB" (selectionChange)="onSelectInteractomeB($event.value)"
                      [value]="formSameSpecies.value.interactomeB">
            <mat-option *ngFor="let interactome of interactomesB" [value]="interactome">
              {{ interactome.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="width-100">
          <mat-label>Gene</mat-label>
          <input #searchInput type="search" matInput placeholder="Start typing something to search genes"
                 formControlName="gene"
                 autocomplete="off"
                 [value]="genesInput" />
        </mat-form-field>
        <div class="div-autocomplete">
          <mat-progress-bar mode="indeterminate" *ngIf="searchingGenes"></mat-progress-bar>
          <mat-accordion>
            <app-autocomplete *ngFor="let gene of genes" [title]="gene.geneId" [names]="gene.names" (radioSelected)="onGeneSelected($event)">
            </app-autocomplete>
          </mat-accordion>
        </div>
        <mat-form-field class="width-25">
          <input type="number" matInput placeholder="Interaction level" formControlName="level" [(ngModel)]="level">
        </mat-form-field>
        <mat-slider thumbLabel tickInterval="1" [min]="1" [max]="3" [(ngModel)]="level" formControlName="level" class="width-75 right"></mat-slider>

        <mat-error *ngIf="formSameSpecies.hasError('invalidForm')">
          {{formSameSpecies.getError('invalidForm')}}
        </mat-error>
        <button mat-raised-button color="primary" (click)="onCompare()" [disabled]="formSameSpecies.status === 'INVALID' || processing">Compare</button>
      </span>
    </form>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="showTable">
  <mat-card-content>
    <a mat-raised-button color="primary" [href]="csvContent" [download]="csvName" *ngIf="csvContent !== ''">Export CSV</a>
    <a mat-raised-button color="primary" [href]="resultUrl + '/interactome/' + interactomeA.id + '/fasta'"
       target="_blank" *ngIf="csvContent !== ''">
      Export {{interactomeA.name}} FASTA
    </a>
    <a mat-raised-button color="primary" [href]="resultUrl + '/interactome/' + interactomeB.id + '/fasta'"
       target="_blank" *ngIf="csvContent !== ''">
      Export {{interactomeB.name}} FASTA
    </a>
    <a mat-raised-button color="primary" [href]="resultUrl + '/interactome/fasta'"
       target="_blank" *ngIf="csvContent !== ''">
      Export Single FASTA
    </a>
    <a *ngIf="permalink" mat-raised-button color="primary" [href]="permalink" target="_blank">
        <mat-icon>link</mat-icon> Permalink to result</a>

    <mat-tab-group>
      <mat-tab label="Table view">
        <mat-table matSort #table [dataSource]="dataSource" class="table-same-species" appAfterViewInit (afterViewInit)="initTable()">
          <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
          <ng-container matColumnDef="GeneA">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Gene A</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneA)" class="gene1">{{row.geneA}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="NameA">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Name A</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneA)" class="gene1">{{row.firstNameA}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="GeneB">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Gene B</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneB)" class="gene1">{{row.geneB}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="NameB">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Name B</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <a (click)="onClickGene(row.geneB)" class="gene1">{{row.firstNameB}}</a>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="ReferenceInteractome">
            <mat-header-cell *matHeaderCellDef mat-sort-header>{{interactomeA.name}}</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <div *ngIf="row.interactomeDegrees[0].id === interactomeA.id">
                Degree {{row.interactomeDegrees[0].degree}}
              </div>
              <div *ngIf="row.interactomeDegrees.length === 2 && row.interactomeDegrees[1].id === interactomeA.id">
                Degree {{row.interactomeDegrees[1].degree}}
              </div>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="TargetInteractome">
            <mat-header-cell *matHeaderCellDef mat-sort-header>{{interactomeB.name}}</mat-header-cell>
            <mat-cell *matCellDef="let row">
              <div *ngIf="row.interactomeDegrees[0].id === interactomeB.id">
                Degree {{row.interactomeDegrees[0].degree}}
              </div>
              <div *ngIf="row.interactomeDegrees.length === 2 && row.interactomeDegrees[1].id === interactomeB.id">
                Degree {{row.interactomeDegrees[1].degree}}
              </div>
            </mat-cell>
          </ng-container>
        </mat-table>
        <mat-paginator #paginator
                       [pageSize]="10"
                       [pageSizeOptions]="[5, 10, 20, 50]">
        </mat-paginator>
      </mat-tab>
      <mat-tab label="Graph view" *ngIf="nodes.length <= 100 || lastQueryMaxDegree <= 1">
        <app-graph [nodes]="nodes" [links]="links" [graphWidth]="graphWidth" [graphHeight]="graphHeight"></app-graph>
        <app-legend-same-species [graphWidth]="graphWidth" [graphHeight]="graphHeight"></app-legend-same-species>
      </mat-tab>
      <mat-tab label="Graph view" *ngIf="nodes.length > 100 && lastQueryMaxDegree > 1">
        <mat-card>
          <h2>Too much genes. Interactions graph is only shown for up to 100 genes when degree is greater than one.</h2>
        </mat-card>
      </mat-tab>
    </mat-tab-group>
  </mat-card-content>
</mat-card>
